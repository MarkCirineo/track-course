// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Course {
  id            String   @id @default(cuid())
  trackmanId    String   @unique
  dbId         String?
  createdAt     DateTime?
  description   String?
  displayName   String
  numbersOfHoles Int?
  courseLocation String?
  difficulty    Int?
  tags         String[] @default([])
  imageUrl      String?
  videoUrl      String?
  latitude      Float?
  longitude     Float?
  googleMapUrl  String?
  syncedAt      DateTime?
  tees         Tee[]
  holes        Hole[]
  bookmarks    Bookmark[]
  coursePlays  CoursePlay[]
  favorites    Favorite[]

  @@index([displayName])
}

model Tee {
  id             String    @id @default(cuid())
  courseId       String
  course         Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teeIndex       Int       // order on course, for batch sync
  par            Int?
  courseDistance Int?
  courseRating   Float?
  slope          Int?
  gender         String?
  kind           String?
  name           String?
  holeTees       HoleTee[]
  coursePlays    CoursePlay[]

  @@index([courseId])
  @@index([courseRating, slope])
  @@index([gender])
}

model Hole {
  id         String    @id @default(cuid())
  courseId   String
  course     Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  name       String?
  holeIndex  Int       // 0-based order on the course
  imageUrls  String[]  @default([])
  holeTees   HoleTee[]
  coursePlayHoleScores CoursePlayHoleScore[]

  @@unique([courseId, holeIndex])
  @@index([courseId])
}

model HoleTee {
  id          String @id @default(cuid())
  holeId      String
  hole        Hole   @relation(fields: [holeId], references: [id], onDelete: Cascade)
  teeId       String
  tee         Tee    @relation(fields: [teeId], references: [id], onDelete: Cascade)
  distance    Int?
  strokeIndex Int?
  par         Int?

  @@unique([holeId, teeId])
  @@index([holeId])
  @@index([teeId])
}

// Auth.js / NextAuth
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId  String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  password      String?   // hashed, for credentials provider
  accounts      Account[]
  sessions      Session[]
  bookmarks     Bookmark[]
  coursePlays   CoursePlay[]
  favorites     Favorite[]
  @@map("users")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime
  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  courseId  String   @map("course_id")
  note      String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("bookmarks")
}

model CoursePlay {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  courseId     String    @map("course_id")
  teeId        String    @map("tee_id")
  holesPlayed  String    @map("holes_played") // "front" | "back" | "full"
  overallScore Int?      @map("overall_score")
  note         String?   @db.Text
  playedAt     DateTime  @default(now()) @map("played_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course       Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tee          Tee       @relation(fields: [teeId], references: [id], onDelete: Cascade)
  holeScores   CoursePlayHoleScore[]
  @@index([userId])
  @@index([userId, courseId])
  @@map("course_plays")
}

model CoursePlayHoleScore {
  id          String     @id @default(cuid())
  coursePlayId String    @map("course_play_id")
  holeId      String     @map("hole_id")
  score       Int
  coursePlay  CoursePlay @relation(fields: [coursePlayId], references: [id], onDelete: Cascade)
  hole        Hole       @relation(fields: [holeId], references: [id], onDelete: Cascade)
  @@unique([coursePlayId, holeId])
  @@index([coursePlayId])
  @@map("course_play_hole_scores")
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  courseId  String   @map("course_id")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("favorites")
}
